{% extends "base.html" %}

{% block title %}Admin Dashboard - Quản lý Chi tiêu{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="fw-bold text-dark">
            <i class="fas fa-cogs me-2"></i>
            Admin Dashboard
        </h2>
        <p class="text-muted">Tổng quan hệ thống và quản lý người dùng</p>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card">
            <div class="card-body text-center">
                <div class="icon text-primary">
                    <i class="fas fa-users"></i>
                </div>
                <div class="amount text-primary">
                    {{ total_users }}
                </div>
                <div class="label">Tổng người dùng</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card">
            <div class="card-body text-center">
                <div class="icon text-info">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="amount text-info">
                    {{ total_transactions }}
                </div>
                <div class="label">Tổng giao dịch</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card">
            <div class="card-body text-center">
                <div class="icon text-success">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <div class="amount text-success">
                    {{ "{:,.0f}".format(total_income) }} ₫
                </div>
                <div class="label">Tổng thu nhập</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card">
            <div class="card-body text-center">
                <div class="icon text-danger">
                    <i class="fas fa-arrow-down"></i>
                </div>
                <div class="amount text-danger">
                    {{ "{:,.0f}".format(total_expense) }} ₫
                </div>
                <div class="label">Tổng chi tiêu</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Users -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-user-plus me-2"></i>
                    Người dùng mới nhất
                </h5>
                <a href="{{ url_for('admin.users') }}" class="btn btn-sm btn-outline-primary">
                    Xem tất cả
                </a>
            </div>
            <div class="card-body">
                {% if recent_users %}
                    {% for user in recent_users %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="mb-1">{{ user.full_name }}</h6>
                            <small class="text-muted">
                                {{ user.email }}
                                {% if user.is_admin %}
                                    <span class="badge bg-warning ms-1">Admin</span>
                                {% endif %}
                            </small>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">{{ user.created_at.strftime('%d/%m/%Y') }}</small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-center">Chưa có người dùng nào</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Top Categories -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Danh mục chi tiêu hàng đầu
                </h5>
            </div>
            <div class="card-body">
                {% if top_categories %}
                    {% for category, amount in top_categories %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="mb-1">{{ category }}</h6>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-primary" role="progressbar" 
                                     style="width: {{ (amount / top_categories[0][1] * 100) if top_categories else 0 }}%"></div>
                            </div>
                        </div>
                        <div class="text-end ms-3">
                            <span class="fw-bold text-danger">{{ "{:,.0f}".format(amount) }} ₫</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-center">Chưa có dữ liệu chi tiêu</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Advanced Analysis Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" id="analysisCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Phân tích thu chi trung bình
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-light btn-sm" id="btn-3months" onclick="showAnalysis('3months')">3 tháng</button>
                    <button type="button" class="btn btn-light btn-sm" id="btn-6months" onclick="showAnalysis('6months')">6 tháng</button>
                    <button type="button" class="btn btn-outline-light btn-sm" id="btn-all" onclick="showAnalysis('all')">Tất cả</button>
                </div>
            </div>
            <div class="card-body">
                <div id="analysisContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-2 text-muted">Đang tải dữ liệu phân tích...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Analysis Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-brain me-2"></i>
                    Phân tích nâng cao
                </h5>
                <button type="button" class="btn btn-primary btn-sm" onclick="showAdvancedAnalysis()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Cập nhật
                </button>
            </div>
            <div class="card-body">
                <div id="advancedAnalysisContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-2 text-muted">Đang tải phân tích nâng cao...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Actions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tools me-2"></i>
                    Công cụ quản trị
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('admin.users') }}" class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-users fa-2x mb-2"></i>
                            <span>Quản lý người dùng</span>
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('admin.categories') }}" class="btn btn-outline-success w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-tags fa-2x mb-2"></i>
                            <span>Quản lý danh mục</span>
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('admin.transactions') }}" class="btn btn-outline-info w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-exchange-alt fa-2x mb-2"></i>
                            <span>Quản lý giao dịch</span>
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button type="button" class="btn btn-outline-warning w-100 h-100 d-flex flex-column justify-content-center" onclick="exportData()">
                            <i class="fas fa-download fa-2x mb-2"></i>
                            <span>Xuất dữ liệu</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/analysis.js') }}"></script>
<script>
function exportData() {
    if (confirm('Bạn có chắc chắn muốn xuất toàn bộ dữ liệu hệ thống?')) {
        window.ExpenseTracker.showAlert('Chức năng xuất dữ liệu đang được phát triển', 'info');
    }
}

// Initialize analysis when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load analysis data
    loadAnalysisData();
    
    // Load advanced analysis
    setTimeout(() => {
        showAdvancedAnalysis();
    }, 1000);
});

// Auto refresh stats every 30 seconds
setInterval(() => {
    location.reload();
}, 30000);
</script>
{% endblock %}
