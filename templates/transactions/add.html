{% extends "base.html" %}

{% block title %}Thêm giao dịch - Quản lý Chi tiêu{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-plus me-2"></i>
                    Thêm giao dịch mới
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="transactionForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" id="csrf_token">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="type" class="form-label">Loại giao dịch *</label>
                            <select class="form-select" id="type" name="type" required onchange="updateCategories()">
                                <option value="">Chọn loại giao dịch</option>
                                <option value="income">Thu nhập</option>
                                <option value="expense">Chi tiêu</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="amount" class="form-label">Số tiền *</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="amount" name="amount" 
                                       placeholder="0" required min="0" step="1000">
                                <span class="input-group-text">₫</span>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="category_id" class="form-label">Danh mục *</label>
                            <select class="form-select" id="category_id" name="category_id" required>
                                <option value="">Chọn danh mục</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}" data-type="{{ category.type }}">
                                        {{ category.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="date" class="form-label">Ngày giao dịch *</label>
                            <input type="date" class="form-control" id="date" name="date" 
                                   value="{{ date.today() }}" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="description" name="description" 
                                  rows="3" placeholder="Mô tả chi tiết về giao dịch này (tùy chọn)"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="receipt" class="form-label">Hóa đơn/Ảnh chứng từ</label>
                        <input type="file" class="form-control" id="receipt" name="receipt" 
                               accept="image/*" onchange="previewImage(this)">
                        <div class="form-text">Chọn ảnh hóa đơn hoặc chứng từ (tùy chọn)</div>
                        
                        <!-- Image preview -->
                        <div id="imagePreview" class="mt-3" style="display: none;">
                            <img id="preview" src="" alt="Preview" class="img-thumbnail" style="max-width: 300px;">
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-success me-2" onclick="extractReceiptInfo()">
                                    <i class="fas fa-magic me-1"></i> Tự động nhập từ ảnh
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeImage()">
                                    <i class="fas fa-times"></i> Xóa ảnh
                                </button>
                            </div>
                        </div>
                        
                        <!-- OCR Progress -->
                        <div id="ocrProgress" class="mt-3" style="display: none;">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span>Đang phân tích ảnh hóa đơn...</span>
                            </div>
                        </div>
                        
                        <!-- OCR Results -->
                        <div id="ocrResults" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-robot me-2"></i>Thông tin được trích xuất từ ảnh:</h6>
                                <div id="extractedInfo"></div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-primary me-2" onclick="applyExtractedInfo()">
                                        <i class="fas fa-check me-1"></i> Áp dụng thông tin
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideOcrResults()">
                                        <i class="fas fa-times me-1"></i> Đóng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save me-2"></i>
                                Lưu giao dịch
                            </button>
                        </div>
                        <div class="col-md-6">
                            <a href="{{ url_for('transactions.index') }}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-arrow-left me-2"></i>
                                Quay lại
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Quick Amount Buttons -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Số tiền thường dùng
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100" onclick="setAmount(50000)">
                            50K
                        </button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100" onclick="setAmount(100000)">
                            100K
                        </button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100" onclick="setAmount(200000)">
                            200K
                        </button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100" onclick="setAmount(500000)">
                            500K
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Similar Transactions -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Giao dịch gần đây
                </h6>
            </div>
            <div class="card-body">
                <div id="recentTransactions">
                    <p class="text-muted text-center">Chọn loại giao dịch để xem giao dịch gần đây</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function updateCategories() {
    const type = document.getElementById('type').value;
    const categorySelect = document.getElementById('category_id');
    const options = categorySelect.querySelectorAll('option');
    
    // Reset selection
    categorySelect.value = '';
    
    // Show/hide options based on type
    options.forEach(option => {
        if (option.value === '') {
            option.style.display = 'block';
            return;
        }
        
        const optionType = option.getAttribute('data-type');
        if (type === '' || optionType === type) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });

    // Load recent transactions
    if (type) {
        loadRecentTransactions(type);
    } else {
        document.getElementById('recentTransactions').innerHTML = 
            '<p class="text-muted text-center">Chọn loại giao dịch để xem giao dịch gần đây</p>';
    }
}

function loadRecentTransactions(type) {
    fetch(`/api/transactions?type=${type}&limit=5`)
        .then(response => response.json())
        .then(transactions => {
            const container = document.getElementById('recentTransactions');
            
            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Chưa có giao dịch nào</p>';
                return;
            }

            const html = transactions.map(transaction => `
                <div class="d-flex justify-content-between align-items-center border-bottom py-2 recent-transaction" 
                     onclick="fillFromRecent(${JSON.stringify(transaction).replace(/"/g, '&quot;')})">
                    <div>
                        <strong>${transaction.category_name}</strong>
                        <br>
                        <small class="text-muted">${transaction.description || 'Không có mô tả'}</small>
                    </div>
                    <div class="text-end">
                        <span class="fw-bold ${type === 'income' ? 'text-success' : 'text-danger'}">
                            ${new Intl.NumberFormat('vi-VN').format(transaction.amount)} ₫
                        </span>
                        <br>
                        <small class="text-muted">${new Date(transaction.date).toLocaleDateString('vi-VN')}</small>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html + '<small class="text-muted">Click vào giao dịch để sao chép thông tin</small>';
        })
        .catch(error => {
            console.error('Error loading recent transactions:', error);
        });
}

function fillFromRecent(transaction) {
    document.getElementById('amount').value = transaction.amount;
    document.getElementById('category_id').value = transaction.category_id;
    document.getElementById('description').value = transaction.description || '';
    
    // Highlight the form briefly
    const form = document.getElementById('transactionForm');
    form.style.backgroundColor = '#f8f9fa';
    setTimeout(() => {
        form.style.backgroundColor = '';
    }, 1000);
}

function setAmount(amount) {
    document.getElementById('amount').value = amount;
    document.getElementById('amount').focus();
}

function previewImage(input) {
    const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('imagePreview');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            preview.src = e.target.result;
            previewContainer.style.display = 'block';
        }
        
        reader.readAsDataURL(input.files[0]);
    }
}

function removeImage() {
    document.getElementById('receipt').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    hideOcrResults();
}

// OCR Functions
let extractedData = null;

function extractReceiptInfo() {
    const fileInput = document.getElementById('receipt');
    
    if (!fileInput.files || !fileInput.files[0]) {
        window.ExpenseTracker.showAlert('Vui lòng chọn ảnh hóa đơn trước!', 'warning');
        return;
    }
    
    const file = fileInput.files[0];
    
    // Validate file size (max 20MB)
    if (file.size > 20 * 1024 * 1024) {
        window.ExpenseTracker.showAlert('File quá lớn! Vui lòng chọn file nhỏ hơn 20MB.', 'danger');
        return;
    }
    
    // Show progress
    document.getElementById('ocrProgress').style.display = 'block';
    hideOcrResults();
    
    // Create FormData
    const formData = new FormData();
    formData.append('receipt_image', file);
    
    // Call OCR API
    fetch('/transactions/extract-receipt', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.getElementById('csrf_token').value
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('ocrProgress').style.display = 'none';
        
        if (data.success) {
            extractedData = data.data;
            displayExtractedInfo(data.data);
            document.getElementById('ocrResults').style.display = 'block';
            window.ExpenseTracker.showAlert('Trích xuất thông tin thành công!', 'success');
        } else {
            window.ExpenseTracker.showAlert('Lỗi: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        document.getElementById('ocrProgress').style.display = 'none';
        console.error('Error:', error);
        window.ExpenseTracker.showAlert('Có lỗi xảy ra khi xử lý ảnh. Vui lòng thử lại.', 'danger');
    });
}

function displayExtractedInfo(data) {
    const infoDiv = document.getElementById('extractedInfo');
    let html = '<div class="row g-2">';
    
    if (data.amount && data.amount > 0) {
        html += `<div class="col-md-6"><strong>Số tiền:</strong> ${new Intl.NumberFormat('vi-VN').format(data.amount)} ₫</div>`;
    }
    
    if (data.date) {
        html += `<div class="col-md-6"><strong>Ngày:</strong> ${data.date}</div>`;
    }
    
    if (data.description) {
        html += `<div class="col-12"><strong>Mô tả:</strong> ${data.description}</div>`;
    }
    
    if (data.merchant) {
        html += `<div class="col-12"><strong>Cửa hàng:</strong> ${data.merchant}</div>`;
    }
    
    if (data.category_suggestion) {
        html += `<div class="col-12"><strong>Danh mục gợi ý:</strong> <span class="badge bg-info">${data.category_suggestion}</span></div>`;
    }
    
    if (data.confidence) {
        const confidencePercent = Math.round(data.confidence * 100);
        const badgeClass = confidencePercent >= 80 ? 'bg-success' : confidencePercent >= 60 ? 'bg-warning' : 'bg-danger';
        html += `<div class="col-12"><strong>Độ tin cậy:</strong> <span class="badge ${badgeClass}">${confidencePercent}%</span></div>`;
    }
    
    if (data.items && data.items.length > 0) {
        html += '<div class="col-12"><strong>Sản phẩm:</strong><ul class="mt-1 mb-0">';
        data.items.forEach(item => {
            html += `<li>${item.name} - ${item.quantity} x ${new Intl.NumberFormat('vi-VN').format(item.price)} ₫</li>`;
        });
        html += '</ul></div>';
    }
    
    html += '</div>';
    infoDiv.innerHTML = html;
}

function applyExtractedInfo() {
    if (!extractedData) return;
    
    // Set amount
    if (extractedData.amount && extractedData.amount > 0) {
        document.getElementById('amount').value = extractedData.amount;
    }
    
    // Set date
    if (extractedData.date) {
        document.getElementById('date').value = extractedData.date;
    }
    
    // Set description
    if (extractedData.description) {
        const currentDesc = document.getElementById('description').value;
        let newDesc = extractedData.description;
        
        if (extractedData.merchant) {
            newDesc += ` - ${extractedData.merchant}`;
        }
        
        if (currentDesc && currentDesc.trim() !== '') {
            newDesc = currentDesc + '\n' + newDesc;
        }
        
        document.getElementById('description').value = newDesc;
    }
    
    // Try to match category
    if (extractedData.category_suggestion) {
        const categorySelect = document.getElementById('category_id');
        const options = categorySelect.getElementsByTagName('option');
        
        for (let option of options) {
            if (option.text.toLowerCase().includes(extractedData.category_suggestion.toLowerCase())) {
                categorySelect.value = option.value;
                break;
            }
        }
    }
    
    // Set transaction type based on context (default to expense)
    document.getElementById('type').value = 'expense';
    filterCategories();
    
    hideOcrResults();
    window.ExpenseTracker.showAlert('Đã áp dụng thông tin từ ảnh!', 'success');
}

function hideOcrResults() {
    document.getElementById('ocrResults').style.display = 'none';
    extractedData = null;
}

// Format number input
document.getElementById('amount').addEventListener('input', function() {
    let value = this.value.replace(/\D/g, '');
    this.value = value;
});

// Form validation
document.getElementById('transactionForm').addEventListener('submit', function(e) {
    const amount = document.getElementById('amount').value;
    const type = document.getElementById('type').value;
    const category = document.getElementById('category_id').value;
    
    if (!amount || !type || !category) {
        e.preventDefault();
        window.ExpenseTracker.showAlert('Vui lòng điền đầy đủ thông tin bắt buộc!', 'danger');
        return false;
    }
    
    if (parseFloat(amount) <= 0) {
        e.preventDefault();
        window.ExpenseTracker.showAlert('Số tiền phải lớn hơn 0!', 'danger');
        return false;
    }
});

// Set today's date as default
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
});
</script>

<style>
.recent-transaction {
    cursor: pointer;
    transition: background-color 0.2s;
}

.recent-transaction:hover {
    background-color: #f8f9fa;
}

#imagePreview {
    border: 2px dashed #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    text-align: center;
}
</style>
{% endblock %}