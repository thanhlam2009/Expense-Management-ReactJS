{% extends "base.html" %}

{% block title %}Dashboard - Qu·∫£n l√Ω Chi ti√™u{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="fw-bold text-dark">
            <i class="fas fa-tachometer-alt me-2"></i>
            Dashboard
        </h2>
        <p class="text-muted">Xin ch√†o, {{ current_user.full_name }}! ƒê√¢y l√† t·ªïng quan t√†i ch√≠nh c·ªßa b·∫°n.</p>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card income">
            <div class="card-body">
                <div class="icon">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <div class="amount text-success">
                    {{ "{:,.0f}".format(total_income) }} ‚Ç´
                </div>
                <div class="label">T·ªïng thu nh·∫≠p</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card expense">
            <div class="card-body">
                <div class="icon">
                    <i class="fas fa-arrow-down"></i>
                </div>
                <div class="amount text-danger">
                    {{ "{:,.0f}".format(total_expense) }} ‚Ç´
                </div>
                <div class="label">T·ªïng chi ti√™u</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card balance">
            <div class="card-body">
                <div class="icon">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="amount {{ 'text-success' if balance >= 0 else 'text-danger' }}">
                    {{ "{:,.0f}".format(balance) }} ‚Ç´
                </div>
                <div class="label">S·ªë d∆∞ hi·ªán t·∫°i</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card savings">
            <div class="card-body">
                <div class="icon">
                    <i class="fas fa-piggy-bank"></i>
                </div>
                <div class="amount text-warning">
                    {% if savings_goals %}
                        {{ "{:.1f}".format(savings_goals[0].progress_percentage) }}%
                    {% else %}
                    {% endif %}
                </div>
                <div class="label">M·ª•c ti√™u ti·∫øt ki·ªám</div>
            </div>
    </div>
</div>

<!-- Budget Alert Card -->
{% if budget_alert and budget_alert.show_alert %}
<div class="row mb-4" id="budgetAlertRow">
    <div class="col-12">
        <div class="card border-{{ budget_alert.alert_color }} shadow-sm" id="budgetAlertCard">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-{{ 'times-circle' if budget_alert.alert_level == 'danger' else 'exclamation-triangle' if budget_alert.alert_color == 'warning' else 'info-circle' }} fa-2x text-{{ budget_alert.alert_color }}"></i>
                            </div>
                            <div>
                                <h6 class="mb-1" id="budgetAlertTitle">{{ budget_alert.alert_title }}</h6>
                                <p class="mb-0 text-muted" id="budgetAlertMessage">{{ budget_alert.alert_message }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-end">
                            <div class="mb-2">
                                <small class="text-muted">Ti·∫øn ƒë·ªô chi ti√™u</small>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-{{ budget_alert.alert_color }}" id="budgetProgressBar" 
                                         style="width: {{ budget_alert.spending_percentage if budget_alert.spending_percentage <= 100 else 100 }}%"></div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="small text-muted">{{ "{:,.0f}".format(budget_alert.current_spending) }}‚Ç´</span>
                                <span class="small text-muted">{{ "{:,.0f}".format(budget_alert.budget_limit) }}‚Ç´</span>
                            </div>
                            <div class="mt-1 text-center">
                                <small class="fw-bold text-{{ budget_alert.alert_color }}">{{ budget_alert.spending_percentage }}%</small>
                            </div>
                            <div class="mt-2">
                                <a href="/budget/settings" class="btn btn-sm btn-outline-{{ budget_alert.alert_color }}">
                                    <i class="fas fa-cog me-1"></i>C√†i ƒë·∫∑t
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Monthly Stats -->
<div class="row mb-4">
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Thu chi theo th√°ng
                </h5>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary" onclick="changeChartPeriod('3m')">3 th√°ng</button>
                    <button type="button" class="btn btn-primary" onclick="changeChartPeriod('6m')">6 th√°ng</button>
                    <button type="button" class="btn btn-outline-primary" onclick="changeChartPeriod('12m')">12 th√°ng</button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar me-2"></i>
                    Th√°ng n√†y
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Thu nh·∫≠p</span>
                        <span class="fw-bold text-success">{{ "{:,.0f}".format(monthly_income) }} ‚Ç´</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ (monthly_income / (monthly_income + monthly_expense) * 100) if (monthly_income + monthly_expense) > 0 else 0 }}%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Chi ti√™u</span>
                        <span class="fw-bold text-danger">{{ "{:,.0f}".format(monthly_expense) }} ‚Ç´</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-danger" role="progressbar" 
                             style="width: {{ (monthly_expense / (monthly_income + monthly_expense) * 100) if (monthly_income + monthly_expense) > 0 else 0 }}%"></div>
                    </div>
                </div>
                
                <hr>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold">Ch√™nh l·ªách</span>
                    <span class="fw-bold {{ 'text-success' if (monthly_income - monthly_expense) >= 0 else 'text-danger' }}">
                        {{ "{:,.0f}".format(monthly_income - monthly_expense) }} ‚Ç´
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions and Category Spending -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Giao d·ªãch g·∫ßn ƒë√¢y
                </h5>
                <a href="{{ url_for('transactions.index') }}" class="btn btn-sm btn-outline-primary">
                    Xem t·∫•t c·∫£
                </a>
            </div>
            <div class="card-body">
                {% if recent_transactions %}
                    {% for transaction in recent_transactions %}
                    <div class="transaction-item {{ transaction.type }} d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6 class="mb-1">{{ transaction.category.name }}</h6>
                            <small class="text-muted">
                                {{ transaction.date.strftime('%d/%m/%Y') }}
                                {% if transaction.description %}
                                    - {{ transaction.description[:30] }}...
                                {% endif %}
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="transaction-amount {{ transaction.type }} fw-bold">
                                {% if transaction.type == 'income' %}+{% else %}-{% endif %}
                                {{ "{:,.0f}".format(transaction.amount) }} ‚Ç´
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Ch∆∞a c√≥ giao d·ªãch n√†o</p>
                        <a href="{{ url_for('transactions.add') }}" class="btn btn-primary">
                            Th√™m giao d·ªãch ƒë·∫ßu ti√™n
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Chi ti√™u theo danh m·ª•c
                </h5>
            </div>
            <div class="card-body">
                {% if category_spending %}
                    {% for category, amount in category_spending %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="mb-1">{{ category }}</h6>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-primary" role="progressbar" 
                                     style="width: {{ (amount / category_spending[0][1] * 100) if category_spending else 0 }}%"></div>
                            </div>
                        </div>
                        <div class="text-end ms-3">
                            <span class="fw-bold text-danger">{{ "{:,.0f}".format(amount) }} ‚Ç´</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu chi ti√™u</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Savings Goals -->
{% if savings_goals %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-target me-2"></i>
                    M·ª•c ti√™u ti·∫øt ki·ªám
                </h5>
                <a href="{{ url_for('transactions.savings_goals') }}" class="btn btn-sm btn-outline-primary">
                    Qu·∫£n l√Ω m·ª•c ti√™u
                </a>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for goal in savings_goals[:3] %}
                    <div class="col-md-4 mb-3">
                        <div class="border rounded p-3">
                            <h6 class="fw-bold">{{ goal.name }}</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <small class="text-muted">{{ "{:,.0f}".format(goal.current_amount) }} ‚Ç´</small>
                                <small class="text-muted">{{ "{:,.0f}".format(goal.target_amount) }} ‚Ç´</small>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar {% if goal.progress_percentage >= 100 %}bg-success{% else %}bg-warning{% endif %}" 
                                     role="progressbar" style="width: {{ goal.progress_percentage }}%"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">{{ "{:.1f}".format(goal.progress_percentage) }}%</small>
                                {% if goal.target_date %}
                                    <small class="text-muted">{{ goal.target_date.strftime('%d/%m/%Y') }}</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Monthly Analysis -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-info" id="analysisCard">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-calculator me-2"></i>
                    üìä Ph√¢n t√≠ch thu chi trung b√¨nh
                </h5>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-light" onclick="showAnalysis('3months')" id="btn-3months">3 th√°ng</button>
                    <button type="button" class="btn btn-light" onclick="showAnalysis('6months')" id="btn-6months">6 th√°ng</button>
                    <button type="button" class="btn btn-outline-light" onclick="showAnalysis('all')" id="btn-all">T·∫•t c·∫£</button>
                </div>
            </div>
            <div class="card-body">
                <div id="analysisContent">
                    <div class="text-center">
                        <div class="spinner-border text-info" role="status"></div>
                        <p class="mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu ph√¢n t√≠ch...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Analysis Section for Users -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-brain me-2"></i>
                    üß† Ph√¢n t√≠ch n√¢ng cao
                </h5>
                <button type="button" class="btn btn-light btn-sm" onclick="showAdvancedAnalysis()">
                    <i class="fas fa-sync-alt me-1"></i>
                    C·∫≠p nh·∫≠t
                </button>
            </div>
            <div class="card-body">
                <div id="advancedAnalysisContent">
                    <div class="text-center">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                        <p class="mt-2 text-muted">ƒêang t·∫£i ph√¢n t√≠ch n√¢ng cao...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="mb-3">Thao t√°c nhanh</h5>
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('transactions.add') }}" class="btn btn-primary w-100">
                            <i class="fas fa-plus me-2"></i>
                            Th√™m giao d·ªãch
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('transactions.savings_goals') }}" class="btn btn-warning w-100">
                            <i class="fas fa-target me-2"></i>
                            M·ª•c ti√™u ti·∫øt ki·ªám
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="/budget/settings" class="btn btn-secondary w-100">
                            <i class="fas fa-wallet me-2"></i>
                            Gi·ªõi h·∫°n chi ti√™u
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button type="button" class="btn btn-info w-100" onclick="showMonthlyReport()">
                            <i class="fas fa-chart-bar me-2"></i>
                            B√°o c√°o th√°ng
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button type="button" class="btn btn-success w-100" onclick="showSpendingSuggestions()">
                            <i class="fas fa-lightbulb me-2"></i>
                            G·ª£i √Ω chi ti√™u
                        </button>
                    </div>
                </div>
                
                <!-- Export Actions Row -->
                <div class="row mt-3">
                    <div class="col-md-4 mb-2">
                        <a href="{{ url_for('main.export_transactions') }}" class="btn btn-outline-success w-100">
                            <i class="fas fa-file-excel me-2"></i>
                            Export Excel
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button type="button" class="btn btn-outline-primary w-100" onclick="printTransactions()">
                            <i class="fas fa-print me-2"></i>
                            In b√°o c√°o
                        </button>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button type="button" class="btn btn-outline-info w-100" onclick="shareReport()">
                            <i class="fas fa-share me-2"></i>
                            Chia s·∫ª
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/analysis.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Create monthly chart
    const ctx = document.getElementById('monthlyChart').getContext('2d');
    const monthlyData = {{ monthly_data | tojson }};
    
    window.ExpenseTracker.createChart(ctx, 'line', {
        labels: monthlyData.map(item => item.month),
        datasets: [{
            label: 'Thu nh·∫≠p',
            data: monthlyData.map(item => item.income),
            borderColor: 'rgb(28, 200, 138)',
            backgroundColor: 'rgba(28, 200, 138, 0.1)',
            fill: true,
            tension: 0.4
        }, {
            label: 'Chi ti√™u',
            data: monthlyData.map(item => item.expense),
            borderColor: 'rgb(231, 74, 59)',
            backgroundColor: 'rgba(231, 74, 59, 0.1)',
            fill: true,
            tension: 0.4
        }]
    }, {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + window.ExpenseTracker.formatCurrency(context.parsed.y);
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return window.ExpenseTracker.formatNumber(value) + ' ‚Ç´';
                    }
                }
            }
        }
    });
});

function changeChartPeriod(period) {
    let months = 6;
    if (period === '3m') months = 3;
    else if (period === '12m') months = 12;
    
    fetch(`/api/stats/monthly?months=${months}`)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            window.ExpenseTracker.createChart(ctx, 'line', {
                labels: data.map(item => item.month_name),
                datasets: [{
                    label: 'Thu nh·∫≠p',
                    data: data.map(item => item.income),
                    borderColor: 'rgb(28, 200, 138)',
                    backgroundColor: 'rgba(28, 200, 138, 0.1)',
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'Chi ti√™u',
                    data: data.map(item => item.expense),
                    borderColor: 'rgb(231, 74, 59)',
                    backgroundColor: 'rgba(231, 74, 59, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            });
            
            // Update button states
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            event.target.classList.remove('btn-outline-primary');
            event.target.classList.add('btn-primary');
        })
        .catch(error => {
            console.error('Error:', error);
            window.ExpenseTracker.showAlert('C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu', 'danger');
        });
}

function showSpendingSuggestions() {
    fetch('/api/spending-suggestions')
        .then(response => response.json())
        .then(data => {
            const content = `
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <h6>G·ª£i √Ω ph√¢n b·ªï thu nh·∫≠p theo quy t·∫Øc 50/30/20:</h6>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 border rounded">
                            <h5 class="text-success">${window.ExpenseTracker.formatCurrency(data.needs)}</h5>
                            <p class="mb-0">Chi ph√≠ thi·∫øt y·∫øu (50%)</p>
                            <small class="text-muted">Nh√† ·ªü, ƒÉn u·ªëng, y t·∫ø</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 border rounded">
                            <h5 class="text-warning">${window.ExpenseTracker.formatCurrency(data.wants)}</h5>
                            <p class="mb-0">Chi ph√≠ mong mu·ªën (30%)</p>
                            <small class="text-muted">Gi·∫£i tr√≠, mua s·∫Øm</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 border rounded">
                            <h5 class="text-info">${window.ExpenseTracker.formatCurrency(data.savings)}</h5>
                            <p class="mb-0">Ti·∫øt ki·ªám (20%)</p>
                            <small class="text-muted">ƒê·∫ßu t∆∞, d·ª± ph√≤ng</small>
                        </div>
                    </div>
                </div>
                <hr>
                <p class="text-muted text-center mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    D·ª±a tr√™n thu nh·∫≠p th√°ng n√†y: ${window.ExpenseTracker.formatCurrency(data.total_income)}
                </p>
            `;
            
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-lightbulb me-2"></i>
                                G·ª£i √Ω ph√¢n b·ªï chi ti√™u
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            window.ExpenseTracker.showAlert('C√≥ l·ªói x·∫£y ra khi t·∫£i g·ª£i √Ω', 'danger');
        });
}

    
    // Load analysis data
    setTimeout(function() {
        loadAnalysisData();
    }, 1000);
    
    // Load advanced analysis for users
    setTimeout(function() {
        showAdvancedAnalysis();
    }, 2000);
    
    // Budget alert now handled server-side

// Budget Alert now handled server-side in template
</script>
{% endblock %}